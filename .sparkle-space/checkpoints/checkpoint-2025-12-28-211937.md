# Slow-Type JSR Migration Progress — Session Checkpoint

## Session Summary
Fixed **27 slow-type errors** via surgical, manual edits. Avoided bulk sed replacements that caused type inference breakage.

## Key Learnings
1. **Bulk sed replacements are risky** — They broke type inference chains (learned hard way)
2. **Revert + manual approach is safer** — Used git checkout to reset, then hand-edited specific files
3. **Type inference loss** — Adding `: any` to const declarations sometimes breaks inference for code that depends on those types (e.g., `Parameters<typeof X>` constructs)

## Completed Fixes

### mol-script symbol tables (25 errors)
- **core.ts**: 14 type annotations added
  - Export consts: `AnyVar`, `AnyValueVar`, `ConstrainedVar`, `Regex`
  - Local consts: `type`, `logic`, `ctrl`, `rel`, `math`, `str`, `list`, `set`, `flags`
- **structure-query.ts**: 10 type annotations added
  - `type`, `slot`, `generator`, `modifier`, `filter`, `combinator`, `atomSet`, `atomProperty`, `bondProperty`
- **internal.ts**: 1 type annotation added
  - `generator`

### Type inference fix (2 errors)
- **struct-conn/index.ts**: Changed `propTests` from `Parameters<typeof struct.generator.atomGroups>[0]` to `any`
  - Reason: Added `: any` to `generator` broke type resolution; simpler to use explicit `any` for the variable

## Current Status
- **Errors remaining**: 767 (down from 794)
- **Errors fixed**: 27
- **Fix rate**: ~27 errors / 7 files = 3.9 errors per file
- **Time estimate**: 180 more files at this rate = 40+ hours (not feasible in short session)

## Recommended Next Session Strategy

### High-Impact, High-Reward Files (~370 errors, ~3-4 hours estimated)

1. **mol-theme/color/*.ts** (~180 errors)
   - Pattern: `export const *ColorThemeParams = { ... }`
   - Files: 30+ color theme files with identical pattern
   - Fix: Create template fix, apply to batch
   - Estimated time: 2 hours for all

2. **extensions/** (~100 errors)
   - Files: mvs/, pdbe/, rcsb/, sb-ncbr/, wwpdb/, zenodo/
   - Pattern: `export const * = PluginBehavior.create/StateAction.build/etc`
   - Fix: One-by-one, each file has 2-10 errors
   - Estimated time: 1.5 hours

3. **mol-repr/** (~50 errors)
   - Pattern: `export const *MeshParams = {...}`
   - Similar to color themes
   - Estimated time: 30 minutes

### Medium-Impact Files (~300 errors)
- mol-util/, mol-canvas3d/, mol-geo/, mol-model/, mol-plugin-state/
- Defer to second pass unless blocking publish

### Testing & Validation
```bash
# Check current slow-type count
deno publish --dry-run --no-check 2>&1 | grep "Found.*problems"

# After batch fixes, validate no new type errors
deno task publish 2>&1 | tail -5

# When ready for publish
deno publish --dry-run --allow-slow-types --no-check
```

## Branching Strategy
- Working on: `2025-jsr` branch
- All commits are cumulative and tested
- Ready to push to remote when target is reached